<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Flight Price – Optimal Booking Time Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Chart.js for line chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f7f9fc;
    }
    h1 {
      text-align: center;
      margin-bottom: 10px;
      color: #1f3c88;
    }
    h2 {
      margin-top: 30px;
      color: #1f3c88;
    }
    .form-section, .result-section {
      background: #ffffff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: 600;
    }
    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      padding: 6px 8px;
      margin-top: 4px;
      border-radius: 5px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    .inline-group {
      display: flex;
      gap: 10px;
    }
    .inline-group > div {
      flex: 1;
    }
    button {
      margin-top: 16px;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      background-color: #1f3c88;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
    }
    button:disabled {
      background-color: #9aa5c4;
      cursor: not-allowed;
    }
    .summary {
      font-size: 15px;
      line-height: 1.6;
    }
    .summary strong {
      color: #d9534f;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 13px;
    }
    th, td {
      border: 1px solid #e0e0e0;
      padding: 6px;
      text-align: center;
    }
    th {
      background: #f1f4ff;
    }
    .best-row {
      background-color: #fff8e1;
    }
    .note {
      font-size: 12px;
      color: #666;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <h1>Optimal Booking Time Demo</h1>
  <p style="text-align:center; font-size: 13px; color: #555;">
    This demo uses the trained regression model to predict ticket prices for the same flight
    under different <code>days_left</code>, plots the price curve, and highlights the day
    with the lowest expected price.
  </p>

  <!-- ===== Form section ===== -->
  <div class="form-section">
    <h2>1. Input flight profile</h2>

    <div class="inline-group">
      <div>
        <label for="airline">Airline</label>
        <input id="airline" type="text" placeholder="e.g. IndiGo, Air India..." />
      </div>
      <div>
        <label for="travel_class">Travel class</label>
        <select id="travel_class">
          <option value="Economy">Economy</option>
          <option value="Business">Business</option>
          <option value="First">First</option>
        </select>
      </div>
    </div>

    <div class="inline-group">
      <div>
        <label for="source_city">Source city</label>
        <input id="source_city" type="text" placeholder="e.g. Delhi" />
      </div>
      <div>
        <label for="destination_city">Destination city</label>
        <input id="destination_city" type="text" placeholder="e.g. Mumbai" />
      </div>
    </div>

    <div class="inline-group">
      <div>
        <label for="departure_time">Departure time slot</label>
        <select id="departure_time">
          <option value="Early Morning">Early Morning</option>
          <option value="Morning">Morning</option>
          <option value="Afternoon">Afternoon</option>
          <option value="Evening" selected>Evening</option>
          <option value="Night">Night</option>
          <option value="Late Night">Late Night</option>
        </select>
      </div>
      <div>
        <label for="arrival_time">Arrival time slot</label>
        <select id="arrival_time">
          <option value="Early Morning">Early Morning</option>
          <option value="Morning">Morning</option>
          <option value="Afternoon">Afternoon</option>
          <option value="Evening">Evening</option>
          <option value="Night" selected>Night</option>
          <option value="Late Night">Late Night</option>
        </select>
      </div>
    </div>

    <div class="inline-group">
      <div>
        <label for="stops">Stops</label>
        <select id="stops">
          <option value="zero">zero (non-stop)</option>
          <option value="one">one (1 stop)</option>
          <option value="two_or_more">two_or_more (2+ stops)</option>
        </select>
      </div>
      <div>
        <label for="duration">Duration (hours)</label>
        <input id="duration" type="number" step="0.1" value="2.0" />
      </div>
    </div>

    <div class="inline-group">
      <div>
        <label for="max_days_left">Max days left</label>
        <input id="max_days_left" type="number" value="60" min="5" max="120" />
        <div class="note">
          For example, 60 means we will predict prices from 1 to 60 days before departure.
        </div>
      </div>
    </div>

    <button id="submitBtn">Generate booking plan</button>
    <div id="errorMsg" style="color:#d9534f; margin-top:8px; font-size:13px;"></div>
  </div>

  <!-- ===== Result section ===== -->
  <div class="result-section">
    <h2>2. Model output: recommended booking time & price curve</h2>
    <div id="summary" class="summary">
      No result yet. Please fill in the form above and click "Generate booking plan".
    </div>

    <canvas id="priceChart" style="margin-top: 16px; max-height: 360px;"></canvas>

    <div id="curveTableContainer"></div>
  </div>

  <script>
    const submitBtn = document.getElementById("submitBtn");
    const errorMsg = document.getElementById("errorMsg");
    const summaryDiv = document.getElementById("summary");
    const curveTableContainer = document.getElementById("curveTableContainer");
    let chartInstance = null;

    async function generatePlan() {
      errorMsg.textContent = "";
      summaryDiv.textContent = "Calling backend model...";
      curveTableContainer.innerHTML = "";
      submitBtn.disabled = true;

      // 1. Collect form values
      const airline = document.getElementById("airline").value.trim();
      const source_city = document.getElementById("source_city").value.trim();
      const destination_city = document.getElementById("destination_city").value.trim();
      const departure_time = document.getElementById("departure_time").value;
      const arrival_time = document.getElementById("arrival_time").value;
      const stops = document.getElementById("stops").value;
      const travel_class = document.getElementById("travel_class").value;
      const duration = Number(document.getElementById("duration").value);
      const max_days_left = Number(document.getElementById("max_days_left").value);

      if (!airline || !source_city || !destination_city || !duration || !max_days_left) {
        errorMsg.textContent = "Please provide airline, cities, duration, and max days left.";
        summaryDiv.textContent = "Form is incomplete.";
        submitBtn.disabled = false;
        return;
      }

      // 2. Build payload (days_left is enumerated inside the backend)
      const payload = {
        airline,
        source_city,
        destination_city,
        departure_time,
        arrival_time,
        stops,
        travel_class,
        duration
      };

      try {
        const resp = await fetch("/booking_plan", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });

        if (!resp.ok) {
          throw new Error("HTTP " + resp.status);
        }

        const data = await resp.json();
        // Expected format:
        // { best_days_left, best_price, curve: [ {days_left, predicted_price}, ... ] }

        // Optionally filter curve by user-defined max_days_left
        let curve = data.curve;
        if (Number.isFinite(max_days_left)) {
          curve = curve.filter(pt => pt.days_left >= 1 && pt.days_left <= max_days_left);
        }

        if (curve.length === 0) {
          summaryDiv.textContent = "Curve data is empty. Please check backend logic.";
          submitBtn.disabled = false;
          return;
        }

        // Find best point within the visible range
        let bestPoint = curve[0];
        for (const pt of curve) {
          if (pt.predicted_price < bestPoint.predicted_price) {
            bestPoint = pt;
          }
        }

        // 3. Text summary
        summaryDiv.innerHTML =
          `✅ Based on the model, the <strong>lowest expected price</strong> in this window is ` +
          `<strong>${bestPoint.predicted_price.toFixed(2)}</strong> (same price unit as in the dataset), ` +
          `when booking <strong>${bestPoint.days_left} days</strong> before departure.`;

        // 4. Line chart
        const labels = curve.map(pt => pt.days_left);
        const prices = curve.map(pt => pt.predicted_price);

        const pointBackgroundColors = prices.map((p, idx) =>
          labels[idx] === bestPoint.days_left ? "#d9534f" : "#1f77b4"
        );
        const pointRadius = prices.map((p, idx) =>
          labels[idx] === bestPoint.days_left ? 6 : 3
        );

        const ctx = document.getElementById("priceChart").getContext("2d");
        if (chartInstance) {
          chartInstance.destroy();
        }

        chartInstance = new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [{
              label: "Predicted price vs. days_left",
              data: prices,
              tension: 0.2,
              fill: false,
              pointBackgroundColor: pointBackgroundColors,
              pointRadius: pointRadius
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                display: true
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return `Price: ${context.parsed.y.toFixed(2)}`;
                  }
                }
              }
            },
            scales: {
              x: {
                title: {
                  display: true,
                  text: "Days left"
                }
              },
              y: {
                title: {
                  display: true,
                  text: "Predicted price"
                }
              }
            }
          }
        });

        // 5. Simple table with first 30 points
        let html = "<table><thead><tr><th>Days left</th><th>Predicted price</th></tr></thead><tbody>";
        const maxRows = Math.min(curve.length, 30);
        for (let i = 0; i < maxRows; i++) {
          const pt = curve[i];
          const isBest = pt.days_left === bestPoint.days_left;
          html += `<tr class="${isBest ? "best-row" : ""}">
                     <td>${pt.days_left}</td>
                     <td>${pt.predicted_price.toFixed(2)}</td>
                   </tr>`;
        }
        html += "</tbody></table>";
        if (curve.length > maxRows) {
          html += `<div class="note">(Only the first ${maxRows} points are shown here. The full curve is available via the API.)</div>`;
        }

        curveTableContainer.innerHTML = html;
      } catch (err) {
        console.error(err);
        errorMsg.textContent = "Error calling /booking_plan. Please check that the backend is running and the endpoint is available.";
        summaryDiv.textContent = "Request failed.";
      } finally {
        submitBtn.disabled = false;
      }
    }

    submitBtn.addEventListener("click", function () {
      generatePlan();
    });
  </script>
</body>
</html>
